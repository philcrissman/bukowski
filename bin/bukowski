#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../lib/bukowski/tokenizer'
require_relative '../lib/bukowski/parser'
require_relative '../lib/bukowski/cached_sk_evaluator'
require_relative '../lib/bukowski/repl'

module Bukowski
  class Runner
    def self.run(args)
      if args.empty?
        # Start REPL
        REPL.new.run
      else
        # Execute file
        execute_file(args[0])
      end
    end

    def self.execute_file(filename)
      unless File.exist?(filename)
        puts "Error: File '#{filename}' not found"
        exit 1
      end

      source = File.read(filename)

      begin
        evaluator = CachedSKEvaluator.new
        results = evaluator.evaluate_program(source)

        if results.empty?
          exit 0
        end

        # Print only the final result
        final_result = results.last

        # Pretty print Church booleans in SK form
        if final_result.is_a?(SK::K)
          puts "true"
        elsif final_result.is_a?(SK::SKApp) &&
              final_result.func.is_a?(SK::K) &&
              final_result.arg.is_a?(SK::I)
          puts "false"
        else
          puts final_result
        end
      rescue => e
        puts "Error: #{e.message}"
        puts e.backtrace if ENV['DEBUG']
        exit 1
      end
    end
  end
end

Bukowski::Runner.run(ARGV)
